<html>
<head>
    <title>Learn D3 in 5 minutes</title>
</head>
<body>

<script src='https://d3js.org/d3.v4.min.js'></script>

<div id="my_dataviz">
  <svg xmlns="http://www.w3.org/2000/svg" style="border:1px solid black">
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" />
      </marker>
    </defs>
    <path d="M 50 550 L 100 565 L 300 565 L 300 785 L 1185 685"
      fill="transparent" stroke="red" />
      <circle cx="50" cy="550" r="5" stroke="black" stroke-width="3" fill="red" />
      <circle cx="100" cy="565" r="5" stroke="black" stroke-width="3" fill="red" />
    <path d="M 50 570 L 100 585 L 320 585 L 320 765 L 1185 665"
      fill="transparent" stroke="red" />

    <path d="M 100 100 L 100 200 L 200 200 L 200 100 C 200,100  400,100  400,200 L 400 700 L 1185 610"
      fill="transparent" stroke="green" />
      <circle cx="200" cy="200" r="5" stroke="black" stroke-width="3" fill="green" />
    <path d="M 80 100 L 80 220 L 220 220 L 220 80 C 220,80  420,80  420,180 L 420 680 L 1185 590"
      fill="transparent" stroke="green" />
    <path d="M 25,75 Q 50,150 75,100 T 150,150 Q 160,220 250,250 Q 300,250 350,200 Q 500,50 1185 665"
      fill="transparent" stroke="blue" />

      <circle cx="50" cy="150" r="5" stroke="black" stroke-width="3" fill="#CCCCCC" />
      <circle cx="75" cy="100" r="5" stroke="black" stroke-width="3" fill="blue" />
      <circle cx="150" cy="150" r="5" stroke="black" stroke-width="3" fill="blue" />
      <circle cx="160" cy="250" r="5" stroke="black" stroke-width="3" fill="#CCCCCC" />
      <circle cx="250" cy="250" r="5" stroke="black" stroke-width="3" fill="blue" />
      <circle cx="300" cy="250" r="5" stroke="black" stroke-width="3" fill="#CCCCCC" />
      <circle cx="350" cy="200" r="5" stroke="black" stroke-width="3" fill="blue" />
      <circle cx="500" cy="50" r="5" stroke="black" stroke-width="3" fill="#CCCCCC" />
      <circle cx="1185" cy="665" r="5" stroke="black" stroke-width="3" fill="blue" />

    <path d="M 25,95 Q 50,170 75,120 T 140,180 Q 155,245 250,270 Q 300,270 350,220 Q 500,70 1185 685"
      fill="transparent" stroke="blue" />
  </svg>
</div>

<div id="secondone" style="background-color:#CCCCCC">
  <svg xmlns="http://www.w3.org/2000/svg" style="border:1px solid black;background-color:#CCC4C5">
  </svg>
</div>

<script>


          // set the dimensions and margins of the graph
          var margin = {top: 10, right: 30, bottom: 30, left: 40},
            width = 1200 - margin.left - margin.right,
            height = 1200 - margin.top - margin.bottom;

          // append the svg object to the body of the page
          var svg = d3.select("#my_dataviz").select("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform",
                  "translate(" + margin.left + "," + margin.top + ")")


          var svg2 = d3.select("#secondone").select("svg")
            .attr("width", 400)
            .attr("height", 300)
          .append("g")

          mydiv = document.getElementById(`secondone`)
            mydiv.style.position = 'absolute';
            mydiv.style.top=700;
            mydiv.style.left=100;
            mydiv.style.width=400;
            mydiv.style.height=300;
            mydiv.style.border='1px solid green';
            mydiv.style.padding='10px';
            mydiv.style.zIndex=10;

          svg2
          .append("line")
          .style("stroke", "purple")
          .style("stroke-width", 3)
          .attr("id", `newline`)
          .attr("x1", 100)
          .attr("y1", 100)
          .attr("x2", 200)
          .attr("y2", 200)




          var myjsondata = {
            "nodes": [
              {
                "id": 1,
                "name": "A",
                "type":1
              },
              {
                "id": 2,
                "name": "B",
                "type":1
              },
              {
                "id": 3,
                "name": "C",
                "type":1
              },
              {
                "id": 4,
                "name": "D",
                "type":2
              },
              {
                "id": 5,
                "name": "E",
                "type":1
              },
              {
                "id": 6,
                "name": "F",
                "type":1
              },
              {
                "id": 7,
                "name": "G",
                "type":2
              },
              {
                "id": 8,
                "name": "H",
                "type":1
              },
              {
                "id": 9,
                "name": "I",
                "type":1
              },
              {
                "id": 10,
                "name": "J",
                "type":2
              },
              {
                "id": 11,
                "name": "K",
                "type":2
              }
            ],
            "links": [
              {
                "source": 1,
                "target": 2
              },
              {
                "source": 1,
                "target": 3
              },
              {
                "source": 1,
                "target": 4
              },
              {
                "source": 2,
                "target": 7
              },
              {
                "source": 3,
                "target": 4
              },
              {
                "source": 8,
                "target": 3
              },
              {
                "source": 4,
                "target": 5
              },
              {
                "source": 4,
                "target": 10
              },
              {
                "source": 4,
                "target": 11
              },
              {
                "source": 6,
                "target": 9
              },
            ]
          }




          function doIt(data) {


            data.nodes.push({
              "id": 12,
              "name": "L",
              "type":2
            })
            data.links.push({
              "source": 10,
              "target": 11
            })
            data.links.push({
              "source": 10,
              "target": 12
            })

            // Initialize the links
            var link = svg
              .selectAll("line")
              .data(data.links)
              .enter()
              .append("line")
                .style("stroke", "red")
                .style("stroke-width",2)


            // Initialize the nodes
            var node = svg
              .selectAll("circle")
              .data(data.nodes)
              .enter()
              .append("circle")
                .attr("r", 20)
                .style("fill", "#69b3a2")
                .style("stroke", "red")
                .style("stroke-width",1)




            //initialize text labels
            var textLabel = svg
              .selectAll("text")
              .data(data.nodes)
              .enter()
              .append("text")
                .text(node => `${node.id}-${node.name}`)
                .attr('font-size',8)//font size
                .attr('dx', -10)//positions text towards the left of the center of the circle
                .attr('dy',4)



            // Let's list the force we wanna apply on the network
            var simulation = d3.forceSimulation(data.nodes)                 // Force algorithm is applied to data.nodes
                .force("link", d3.forceLink()                               // This force provides links between nodes
                      .id(function(d) { return d.id; })                     // This provide  the id of a node
                      .links(data.links)                                    // and this the list of links
                )
                .force("charge", d3.forceManyBody().strength(-500))         // This adds repulsion between nodes. Play with the -400 for the repulsion strength
                .force("center", d3.forceCenter(width / 2, height / 2))     // This force attracts nodes to the center of the svg area
                .on("end", ticked);

            // This function is run at each iteration of the force algorithm, updating the nodes position.
            var lineCount = 0;
            function ticked() {
              link
                  .attr("x1", function(d) { return d.source.x; })
                  .attr("y1", function(d) { return d.source.y; })
                  .attr("x2", function(d) { return d.target.x; })
                  .attr("y2", function(d) { return d.target.y; })
                  //.attr("marker-end","url(#arrowhead)")


              node
                   .attr("cx", function (d) { return d.x+6; })
                   .attr("cy", function(d) {
                     console.log(`this d name ${d.name}`);
                     console.log(this)
                     if(d.type == 2){
                       this.style.fill = '#CCCCCC';
                       this.style.stroke = 'purple';
                       this.style.strokeWidth = 2
                     }
                     /***
                     let text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                      text.setAttribute('x', '30');
                      text.setAttribute('y', '50');
                      text.setAttribute('font-size', '50em');
                      text.setAttribute('fill', '#000000');
                      text.textContent = d.name;
                      this.appendChild(text);
                      ***/
                     return d.y-6;
                   })
                   .on("mouseenter", function(){
                     console.log(`hello there`)
                     this.setAttribute('r', 23)
                   })
                   .on("mouseout", function(){
                     console.log(`hello there`)
                     this.setAttribute('r', 20)
                   })
                   .on("click", function(e){
                     console.log(`clicked bigsvg ${parseFloat(parseFloat(400/1200)*parseFloat(this.cx.animVal.value))} cx ${this.cx.animVal.value}`)
                     let minix = parseFloat(parseFloat(400/1200)*parseFloat(this.cx.animVal.value));
                     let miniy = parseFloat(parseFloat(300/1200)*parseFloat(this.cy.animVal.value))
                     svg2
                       .append("rect")
                       .attr("x", minix)
                       .attr("width", 10)
                       .attr("y", miniy)
                       .attr("height", 10)
                       .style("fill", '#CCCCCC')
                       .style("stroke", 'green')
                       .style("strokeWidth", 1)
                      svg2
                       .append("line")
                       .style("stroke", "green")
                       .style("stroke-width", 3)
                       .attr("id", `ln2${parseInt(lineCount)}`)
                       .attr("x1", minix)
                       .attr("y1", miniy)
                       .attr("x2", parseFloat(minix+(100/3)))
                       .attr("y2", parseFloat(miniy+(100/3)))

                       if(lineCount > 0){
                         svg2.select(`#ln2${parseInt(lineCount-1)}`)
                           .attr("x2", parseFloat(minix))
                           .attr("y2", parseFloat(miniy))
                           .on("click", function(){
                             for(i=0;i<=lineCount;i+=1){
                               svg.select(`#ln${parseInt(i)}`).remove()
                             }
                           })
                       }

                     console.log(this)
                     svg
                       .append("rect")
                       .attr("x", this.cx.animVal.value)
                       .attr("width", 30)
                       .attr("y", this.cy.animVal.value)
                       .attr("height", 30)
                       .style("fill", '#CCCCCC')
                       .style("stroke", 'green')
                       .style("strokeWidth", 2)
                       .on("click", function(){
                         svg.selectAll("rect").remove()
                       })
                      svg
                        .append("line")
                        .style("stroke", "lightgreen")
                        .style("stroke-width", 10)
                        .attr("id", `ln${parseInt(lineCount)}`)
                        .attr("x1", this.cx.animVal.value)
                        .attr("y1", this.cy.animVal.value)
                        .attr("x2", this.cx.animVal.value+100)
                        .attr("y2", this.cy.animVal.value+100)
                        /***
                        .on("mousemove",(ev)=>{
                          console.log(d3.event.x)
                            .attr("x2", d3.event.x)
                            .attr("y2", d3.event.y)
                        })
                        ***/
                      if(lineCount > 0){
                        svg.select(`#ln${parseInt(lineCount-1)}`)
                          .attr("x2", this.cx.animVal.value)
                          .attr("y2", this.cy.animVal.value)
                          .on("click", function(){
                            for(i=0;i<=lineCount;i+=1){
                              svg.select(`#ln${parseInt(i)}`).remove()
                            }
                          })
                      }
                      lineCount+=1;
                   })



              textLabel
                .attr("dx", function (d) { return d.x; })
                .attr("dy", function (d) { return d.y; })

            }

          }

          doIt(myjsondata);
</script>
</body>
</html>
